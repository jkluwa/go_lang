<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .form {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        body {
            display: flex;
            justify-content: space-between;
        }
    </style>
    <script>
        function writeStudents() {
            const writeXhttp = new XMLHttpRequest()
            writeXhttp.onreadystatechange = () => {
                document.getElementById("students").innerHTML = writeXhttp.responseText
            }
            writeXhttp.open("GET", "http://localhost:8080/v1/student")
            
            writeXhttp.send()
        }
        function Refresh() {
            const refreshXhttp = new XMLHttpRequest()
            refreshXhttp.open("POST", "http://localhost:8080/v2/refresh")
            refreshXhttp.setRequestHeader("Refresh", window.localStorage.getItem("refresh_token"))
            refreshXhttp.send()
            refreshXhttp.onreadystatechange = () => {
                switch (document.readyState) {
                    case "complete": 
                        var response = JSON.parse(refreshXhttp.responseText)
                        window.localStorage.setItem("access_token", response.access_token)
                        window.localStorage.setItem("refresh_token", response.refresh_token)
                }
            }
        }
        function getRole() {
            const roleXhttp = new XMLHttpRequest()
            roleXhttp.onreadystatechange = () => {
                if(roleXhttp.responseText == "administrator") {
                    document.getElementById("role").innerHTML = "hello administrator, you can do anyhing"
                } else if (roleXhttp.responseText == "developer") {
                    document.getElementById("role").innerHTML = "hello developer, you can update students' informations"
                } else {
                    
                    //Refresh();
                }
                
            }
            roleXhttp.open("POST", "http://localhost:8080/v2/role")
            roleXhttp.setRequestHeader("Authorization", window.localStorage.getItem("access_token"))
            roleXhttp.send()
        }

        function add() {
            const addXhttp = new XMLHttpRequest()
            const name = document.getElementById("addName").value
            const surname = document.getElementById("addSurname").value
            const age = document.getElementById("addAge").value
            addXhttp.open("POST", "http://localhost:8080/v1/student")
            addXhttp.withCredentials = false
            let json = JSON.stringify({
                Name: name,
                Surname: surname,
                Age: age
            })
            addXhttp.setRequestHeader("Content-type", "application/json")
            addXhttp.setRequestHeader("Authorization", window.localStorage.getItem("access_token"))
            addXhttp.send(json)
            
            }
        function del() {
            const delXhttp = new XMLHttpRequest()
            const id = document.getElementById("deleteId").value
            delXhttp.open("DELETE", "http://localhost:8080/v1/student/"+id)
            delXhttp.withCredentials = false
            delXhttp.setRequestHeader("Content-type", "application/json")
            delXhttp.setRequestHeader("Authorization", window.localStorage.getItem("access_token"))
            delXhttp.send()
        }
        function update() {
            const updateXhttp = new XMLHttpRequest()
            const id = document.getElementById("updateId").value
            const name = document.getElementById("updateName").value
            const surname = document.getElementById("updateSurname").value
            const age = document.getElementById("updateAge").value
            updateXhttp.open("PUT", "http://localhost:8080/v1/student/"+id)
            updateXhttp.withCredentials = false
            updateXhttp.setRequestHeader("Content-type", "application/json")
            updateXhttp.setRequestHeader("Authorization", window.localStorage.getItem("access_token"))
            let json = JSON.stringify({
                Name: name,
                Surname: surname,
                Age: age
            })
            updateXhttp.send(json)
        }
        function login() {
            const loginXhttp = new XMLHttpRequest()
            const username = document.getElementById("loginName")
            const password = document.getElementById("loginPassword")
            loginXhttp.open("POST", "http://localhost:8080/v2/login")
            loginXhttp.withCredentials = false
            //xhttp.setRespondHeader("Content-type", "application/json")
            loginXhttp.setRequestHeader("Content-type", "application/json")
            let json = JSON.stringify({
                username: username.value,
                password: password.value,
            })
            loginXhttp.send(json)
            loginXhttp.onreadystatechange = () => {
                var response = JSON.parse(loginXhttp.responseText)
                window.localStorage.setItem("access_token", response.access_token)
                window.localStorage.setItem("refresh_token", response.refresh_token)
            }
            
        }
        function register() {
            const registerXhttp = new XMLHttpRequest()
            const username = document.getElementById("registerName").value
            const password = document.getElementById("registerPassword").value
            const role = document.getElementById("registerRole").value
            registerXhttp.open("POST", "http://localhost:8080/v2/register")
            registerXhttp.withCredentials = false
            registerXhttp.setRequestHeader("Content-type", "application/json")
            let json = JSON.stringify({
                username: username,
                password: password,
                role: role,
            })
            registerXhttp.send(json)
        }
    </script>
</head>
<body>
    <div id="role"></div>
    <div class="form">
        <label>username</label><input id="registerName" name="name" type="text" />
        <label>password</label><input id="registerPassword" name="password" type="password" />
        <label>role</label>
        <select name="role" id="registerRole">
            <option value="administrator">administrator</option>
            <option value="developer">developer</option>
        </select>
        <button onclick="return register()" >Register</button>
    </div>

    <div class="form">
        <label>username</label><input id="loginName" name="name" type="text" />
        <label>password</label><input id="loginPassword" name="password" type="password" />
        <button onclick="return login()" >Login</button>
    </div>

    <div class="form">
        <label>name</label><input id="addName" name="name" type="text" />
        <label>surname</label><input id="addSurname" name="surname" type="text" />
        <label>age</label><input id="addAge" name="age" type="number" min="5" />
        <button onclick="return add()" >Add student</button>
    </div>
    <div class="form">
        <label>id</label><input id="deleteId" type="text" />
        <button onclick="return del()" >Delete student</button>
    </div>
    <div class="form">
        <label>id</label><input type="text" id="updateId">
        <label>name</label><input id="updateName" type="text" />
        <label>username</label><input id="updateSurname" type="text" />
        <label>age</label><input id="updateAge" type="number" min="5" />
        <button onclick="return update()" >Update student</button>
    </div>
    <div id="students"></div>
    <script>
    writeStudents()
    if(window.localStorage.getItem("access_token")) {
        getRole()
    }
    </script>
</body>
</html>